#!/usr/bin/env bash

set -o errexit

npm run build
binary=../../bin/elm-typescript-interop

for testFolder in ./test_data/*
do
  echo "Testing generator with $testFolder folder"
  cd $testFolder
  outputBase=`basename $testFolder`
  # outputPath=../../tests/e2e/output/$outputBase.d.ts
  $binary src/Main.elm
  cd ../..
done

echo "Checking that all TypeScript declaration files are valid..."
for declarationFile in $(find test_data -type f -name "*.d.ts"); do echo $declarationFile; tsc $declarationFile; done

# echo 'Ensuring documentation is valid...'
# elm make --docs=documentation.json

echo 'Confirming that generated code is unchanged...'
git diff --exit-code -- 'test_data/**/*.d.ts' || (echo 'FAILURE' && echo 'examples code has changed. Commit changes to approve.' && exit 1)


# npm run approve-compilation

echo 'SUCCESS'
